services:
  cotizador-backend:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      NODE_ENV: ${NODE_ENV}
      PORT: ${PORT}
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_DATABASE: ${DB_DATABASE}
      DB_TEST_DATABASE: ${DB_TEST_DATABASE}
      EMAIL_HOST: ${EMAIL_HOST}
      EMAIL_PORT: ${EMAIL_PORT}
      EMAIL_USER: ${EMAIL_USER}
      EMAIL_PASS: ${EMAIL_PASS}
      ERP_PROXY_API_ENDPOINT: ${ERP_PROXY_API_ENDPOINT}
      ERP_PROXY_API_KEY: ${ERP_PROXY_API_KEY}
      DATA_TRANSFORMER_API_ENDPOINT: ${DATA_TRANSFORMER_API_ENDPOINT}
      DATA_TRANSFORMER_API_KEY: ${DATA_TRANSFORMER_API_KEY}
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRE: ${JWT_EXPIRE}
      AWS_S3_ENDPOINT: ${AWS_S3_ENDPOINT}
      AWS_S3_PUBLIC_ENDPOINT: ${AWS_S3_PUBLIC_ENDPOINT}
      AWS_S3_PORT: ${AWS_S3_PORT}
      AWS_S3_REGION: ${AWS_S3_REGION}
      AWS_S3_ACCESS_KEY_ID: ${AWS_S3_ACCESS_KEY_ID}
      AWS_S3_SECRET_ACCESS_KEY: ${AWS_S3_SECRET_ACCESS_KEY}
      AWS_S3_BUCKET_NAME: ${AWS_S3_BUCKET_NAME}
    labels:
      - "traefik.enable=true"
      # API routes
      - "traefik.http.routers.cotizador-backend.rule=Host(`cotizador.modasa.com.pe`) && PathPrefix(`/api`)"
      - "traefik.http.routers.cotizador-backend.entrypoints=websecure"
      - "traefik.http.routers.cotizador-backend.tls=true"
      - "traefik.http.services.cotizador-backend.loadbalancer.server.port=3000"
      - "traefik.http.routers.cotizador-backend.middlewares=cotizador-backend-strip"
      - "traefik.http.middlewares.cotizador-backend-strip.stripprefix.prefixes=/api"
      # WebSocket routes
      - "traefik.http.routers.cotizador-websocket.rule=Host(`cotizador.modasa.com.pe`) && PathPrefix(`/socket.io`)"
      - "traefik.http.routers.cotizador-websocket.entrypoints=websecure"
      - "traefik.http.routers.cotizador-websocket.tls=true"
      - "traefik.http.routers.cotizador-websocket.service=cotizador-backend"
    networks:
      - dokploy-network

networks:
  dokploy-network:
    external: true
